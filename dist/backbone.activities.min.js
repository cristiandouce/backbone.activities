(function(a){function f(){return Backbone.History.apply(this,arguments)}function j(a){this.pattern=a,this._addParamName=_.bind(this._addParamName,this),this.paramNames=[],this.regExp=this._routeToRegExp(a)}function k(a){this.params=a||{},this.initialize.apply(this,arguments)}function l(a){this.currentPlace=a,this.initialize.apply(this,arguments)}function m(a,b){this.Place=a,this.Activity=b,this.pattern=a.prototype.pattern}function o(a){this.displayRegion=a,this._matchs=[]}function q(){this._managers=[],this._bindEvents()}var b=this,c;typeof exports!="undefined"?c=exports:c=b.activities={},c.VERSION="0.2.2",!a&&typeof require!="undefined"&&(b.jQuery=a=require("jquery")),!b.Backbone&&typeof require!="undefined"&&(b.Backbone=require("backbone")),!b._&&typeof require!="undefined"&&(b._=require("underscore")._),b.Backbone.activities=c,c.helpers={};var d=function(a){var b=a.prototype.place;if(!b)throw new Error("Activity must have a `place` property");return _.isArray(b)?b:[b]};c.helpers.extend=Backbone.View.extend,c.helpers.getPlaces=d,c.helpers.resolvedPromise=null;var e={};_.extend(e,Backbone.Events),c.getEventBus=function(){return e},_.extend(f.prototype,Backbone.History.prototype,{eventBus:e,loadUrl:function(a){var b=Backbone.History.prototype.loadUrl.apply(this,arguments),c=this.getFragment();return this.eventBus.trigger("historyChange",c),!0}}),c.History=f,c.history||(c.history=new f);var g={eventBus:c.getEventBus(),goTo:function(a){this.eventBus.trigger("placeChangeRequest",a)}};c.getPlaceController=function(){return g};var h=/[-[\]{}()+?.,\\^$|#\s]/g,i=/:(\w+)/g;j.prototype._routeToRegExp=function(a){var b;return b=a.replace(h,"\\$&").replace(i,this._addParamName),new RegExp("^"+b+"$")},j.prototype._extractParameters=function(a){var b,c,d,e,f,g,h;f={},d=this.regExp.exec(a),h=d.slice(1);for(b=0,g=h.length;b<g;b++)c=h[b],e=this.paramNames[b],f[e]=c;return f},j.prototype._addParamName=function(a,b){return this.paramNames.push(b),"([^/]+)"},j.prototype.test=function(a){var b;return b=this.regExp.test(escape(a)),b?!0:!1},c.Route=j,_.extend(k.prototype,{pattern:null,initialize:function(){},getRoute:function(){var a,b=this.pattern;for(a in this.params)b=b.replace(":"+a,this.params[a]);return b},getParams:function(){return this.params},equals:function(a){return a instanceof this.constructor&&this._equalParams(a)?!0:!1},_equalParams:function(a){var b=a.getParams();return _.isEqual(b,this.params)}}),k.extend=c.helpers.extend,c.Place=k,_.extend(l.prototype,{placeController:c.getPlaceController(),eventBus:c.getEventBus(),initialize:function(a){},start:function(a){},stop:function(){},cancel:function(){},mayStop:function(){return!0},goTo:function(a){this.placeController.goTo(a)}}),l.extend=c.helpers.extend,c.Activity=l,_.extend(m.prototype,{test:function(a){var b,d;if(a instanceof this.Place)return!0;if(typeof a=="string"){this.route=new c.Route(this.pattern);if(this.route.test(a))return!0}return!1},buildPlace:function(a){var b;if(!this.route)throw new Error("place can only be built when the original place is a string");return b=this.route._extractParameters(a),new this.Place(b)}}),c.Match=m;var n=function(a){this.setElement(a)};_.extend(n.prototype,{show:function(b){this.close();if(b instanceof Backbone.View)b.render(),this.$el.html(b.el);else{if(!(b instanceof a||typeof b=="string"))throw new TypeError("DisplayRegion#show: invalid type for `view`.");this.$el.html(b)}},close:function(){this.$el.empty()},setElement:function(b){return this.$el=a(b),this.el=this.$el[0],this}}),n.extend=c.helpers.extend,c.DisplayRegion=n,_.extend(o.prototype,{eventBus:c.getEventBus(),register:function(a){var b=0,d,e,f,g=c.helpers.getPlaces(a);d=g.length;for(;b<d;b++)e=g[b],f=new c.Match(e,a),this._matchs.push(f)},_findMatch:function(a){var b,c,d,e;e=this._matchs;for(c=0,d=e.length;c<d;c++){b=e[c];if(b.test(a))return b}return!1},_createPlace:function(a){var b,c,d,e,f;e=this._matchs;for(c=0,d=e.length;c<d;c++){b=e[c];if(b.test(a))return b.buildPlace(a)}return!1},reset:function(){this.displayRegion&&this.displayRegion.close(),this.currentActivity=null},load:function(a){var b,d=!0,e,f=c.helpers.resolvedPromise;return e=this._findMatch(a),e?a.equals(this._currentPlace)?f:(this._currentPlace=a,b=new e.Activity(a),this._deactivate(this.currentActivity),this.currentActivity=b,this._activate(b)):(this.reset(),f)},_activate:function(b){var c=this,d=new p(this);return this._promise=d.getPromise(),this._startingNext=!0,a.when(this._promise).then(function(){c._startingNext=!1}),b.start(d),this._promise},_deactivate:function(a){var b=this;a&&(this._startingNext?a.cancel():a.stop())},mayStopCurrentActivity:function(){return!this.currentActivity||this._startingNext?!0:this.currentActivity.mayStop()},showView:function(a){this.displayRegion&&this.displayRegion.show(a)},getCurrentActivity:function(){return this.currentActivity},getDisplayRegion:function(){return this.displayRegion}});var p=function(b){this.activity=b.getCurrentActivity(),this.activityManager=b,this._deferred=a.Deferred(),this._promise=this._deferred.promise()};_.extend(p.prototype,{setView:function(a){var b=this.activityManager;this.activity==b.getCurrentActivity()&&(b.showView(a),this._deferred.resolve(b._currentPlace))},getPromise:function(){return this._promise},finish:function(){this._deferred.resolve()}}),c.ActivityManager=o,_.extend(q.prototype,Backbone.Events,{eventBus:c.getEventBus(),_bindEvents:function(){this.eventBus.bind("placeChangeRequest",this._onPlaceChangeRequest,this),this.eventBus.bind("historyChange",this._onHistoryChange,this)},_unbindEvents:function(){this.eventBus.unbind("placeChangeRequest",this._onPlaceChangeRequest),this.eventBus.unbind("historyChange",this._onHistoryChange)},register:function(a){this._managers.push(a)},_mayStop:function(){var a,b=this._managers.length,c;for(a=0;a<b;a++){c=this._managers[a];if(!c.mayStop())return!1}return!0},_onHistoryChange:function(a){var b=this._createPlace(a);b||this.trigger("placeNotFound",a),this._triggerPlaceChange(b)},_onPlaceChangeRequest:function(a){if(!this._mayLoadPlace())return;this._triggerPlaceChange(a),this._navigate(a)},_mayLoadPlace:function(){var a=this,b,c=this._managers.length,d;for(b=0;b<c;b++){d=this._managers[b];if(!d.mayStopCurrentActivity())return!1}return!0},_triggerPlaceChange:function(a){var b=this;this.trigger("beforePlaceChange"),this._loadManagers(a,function(){b.trigger("placeChange",a)})},_loadManagers:function(b,c){var d,e=this._managers.length,f,g,h=[];for(d=0;d<e;d++)f=this._managers[d],g=f.load(b),h.push(g);a.when.apply(null,h).then(c)},_navigate:function(a){this._currentPlace=a,c.history.navigate(a.getRoute(),{navigate:!1})},getCurrentPlace:function(){return this._currentPlace},_createPlace:function(a){var b,c=this._managers.length,d,e;for(b=0;b<c;b++){d=this._managers[b],e=d._createPlace(a);if(e)break}return e}}),c.Application=q}).call(this,this.jQuery||this.Zepto);