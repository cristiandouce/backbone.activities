((function(a){function f(){return Backbone.History.apply(this,arguments)}function h(a){this.pattern=a,this._addParamName=_.bind(this._addParamName,this),this.paramNames=[],this.regExp=this._routeToRegExp(a)}function i(a){this.params=a,this.initialize.apply(this,arguments)}function j(a){this.currentPlace=a,this.initialize.apply(this,arguments)}function k(a,b){this.Place=a,this.Activity=b,this.pattern=a.prototype.pattern}function m(a){this.DisplayRegion=a,this._matchs=[]}function n(){this._managers=[],this.bindEvents()}var b=this,c;typeof exports!="undefined"?c=exports:c=b.activities={},c.VERSION="0.1.0",!a&&typeof require!="undefined"&&(b.jQuery=a=require("jquery")),!b.Backbone&&typeof require!="undefined"&&(b.Backbone=require("backbone")),!b._&&typeof require!="undefined"&&(b._=require("underscore")._),b.Backbone.activities=c,c.helpers={};var d=function(a){var b=a.prototype.place;if(!b)throw new Error("Activity must have a `place` property");return _.isArray(b)?b:[b]};c.helpers.extend=Backbone.View.extend,c.helpers.getPlaces=d,c.helpers.resolvedPromise=null;var e={};_.extend(e,Backbone.Events),c.getEventBus=function(){return e},_.extend(f.prototype,Backbone.History.prototype,{eventBus:e,loadUrl:function(a){var b=Backbone.History.prototype.loadUrl.apply(this,arguments),c=this.getFragment();return this.eventBus.trigger("historyChange",c),!0}}),c.History=f,c.history||(c.history=new f);var g={eventBus:c.getEventBus(),goTo:function(a){this.eventBus.trigger("placeChangeRequest",a)}};c.getPlaceController=function(){return g},h.prototype._routeToRegExp=function(a){var b;return b=a.replace(/:(\w+)/g,this._addParamName),new RegExp("^"+b+"(?=\\?|$)")},h.prototype._extractParameters=function(a){var b,c,d,e,f,g,h;f={},d=this.regExp.exec(a),h=d.slice(1);for(b=0,g=h.length;b<g;b++)c=h[b],e=this.paramNames[b],f[e]=c;return f},h.prototype._addParamName=function(a,b){return this.paramNames.push(b),"([\\w-]+)"},h.prototype.test=function(a){var b;return b=this.regExp.test(a),b?!0:!1},c.Route=h,_.extend(i.prototype,{pattern:null,initialize:function(){},getRoute:function(){var a,b=this.pattern;for(a in this.params)b=b.replace(":"+a,this.params[a]);return b},getParams:function(){return this.params}}),i.extend=c.helpers.extend,c.Place=i,_.extend(j.prototype,{placeController:c.getPlaceController(),eventBus:c.getEventBus(),initialize:function(a){},start:function(a){},stop:function(){},cancel:function(){},mayStop:function(){return!0},goTo:function(a){this.placeController.goTo(a)}}),j.extend=c.helpers.extend,c.Activity=j,_.extend(k.prototype,{test:function(a){var b,d;if(a instanceof this.Place)return!0;if(typeof a=="string"){this.route=new c.Route(this.pattern);if(this.route.test(a))return!0}return!1},buildPlace:function(a){var b;if(!this.route)throw new Error("place can only be built when the original place is a string");return b=this.route._extractParameters(a),new this.Place(b)}}),c.Match=k;var l=function(a){a=a||{},this.setElement(a.el||this.el),this.loaded()};_.extend(l.prototype,{show:function(b){if(!this._deferred)return;this.close();if(b instanceof Backbone.View)this.$el.html(b.el);else{if(!(b instanceof a||typeof b=="string"))throw new TypeError("DisplayRegion#show: invalid type for `view`.");this.$el.html(b)}this.resolve()},close:function(){this.$el.empty()},loaded:function(){var b=a.Deferred(),c=b.promise();return this._deferred=b,c},invalidate:function(){this._deferred&&(this._deferred.reject(),this._deferred=null)},resolve:function(){this._deferred&&(this._deferred.resolve(),this._deferred=null)},setElement:function(b){return this.$el=a(b),this.el=this.$el[0],this}}),l.extend=c.helpers.extend,c.DisplayRegion=l,_.extend(m.prototype,{eventBus:c.getEventBus(),register:function(a){var b=0,d,e,f,g=c.helpers.getPlaces(a);d=g.length;for(;b<d;b++)e=g[b],f=new c.Match(e,a),this._matchs.push(f)},_findMatch:function(a){var b,c,d,e;e=this._matchs;for(c=0,d=e.length;c<d;c++){b=e[c];if(b.test(a))return typeof a=="string"&&(a=b.buildPlace(a)),b}return!1},reset:function(){this.displayRegion.close(),this.currentActivity=null,this._lastMatch=null},load:function(a){var b,d=!0,e,f=c.helpers.resolvedPromise;return e=this._findMatch(a),e?this._lastMatch===e?f:(this._lastMatch=e,b=new e.Activity(a),this._deactivate(this.currentActivity),this.currentActivity=b,this._activate(b)):(this.reset(),f)},_activate:function(b){var c=this;return this.displayRegion=new this.DisplayRegion,this._promise=this.displayRegion.loaded(),this._startingNext=!0,a.when(this._promise).then(function(){c._startingNext=!1}),b.start(this.displayRegion),this._promise},_deactivate:function(a){var b=this;a&&(this._startingNext?(this.displayRegion.invalidate(),a.cancel()):a.stop())},mayStopCurrentActivity:function(){return!this.currentActivity||this._startingNext?!0:this.currentActivity.mayStop()}}),c.ActivityManager=m,_.extend(n.prototype,Backbone.Events,{eventBus:c.getEventBus(),bindEvents:function(){this.eventBus.bind("placeChangeRequest",this._onPlaceChangeRequest,this),this.eventBus.bind("historyChange",this._onHistoryChange,this)},register:function(a){this._managers.push(a)},_mayStop:function(){var a,b=this._managers.length,c;for(a=0;a<b;a++){c=this._managers[a];if(!c.mayStop())return!1}return!0},_onHistoryChange:function(a){this._triggerPlaceChange(a)},_onPlaceChangeRequest:function(a){if(!this._mayLoadPlace())return;this._triggerPlaceChange(a),c.history.navigate(a.getRoute(),{navigate:!1})},_mayLoadPlace:function(){var a=this,b,c=this._managers.length,d;for(b=0;b<c;b++){d=this._managers[b];if(!d.mayStopCurrentActivity())return!1}return!0},_triggerPlaceChange:function(b){var c=this,d,e=this._managers.length,f,g,h=[];this.trigger("beforePlaceChange");for(d=0;d<e;d++)f=this._managers[d],g=f.load(b),h.push(g);return a.when.apply(null,h).then(function(){c.trigger("placeChange",b)})}}),c.Application=n})).call(this,this.jQuery||this.Zepto);